<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MGNREGA District Performance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  </head>
  <body class="bg-slate-100 font-sans">
    <header class="bg-blue-600 text-white p-4">
      <h1 class="text-4xl font-bold">MGNREGA District Performance</h1>
    </header>
    <main class="container mx-auto p-4 max-w-7xl">
      <section class="mb-4">
        <label
          for="district-select"
          class="block text-sm font-medium text-gray-700"
          >Select District:</label
        >
        <select
          id="district-select"
          class="mt-1 block w-full p-2 border border-gray-300 rounded-md"
        >
          <option value="">Loading districts...</option>
        </select>
      </section>
      <div id="loading-spinner" class="hidden flex justify-center items-center">
        <div
          class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"
        ></div>
      </div>
      <div
        id="error-message"
        class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"
      >
        An error occurred while loading data.
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <div class="bg-white p-4 rounded-lg shadow">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-lg font-semibold">Work Availability</h3>
            <i data-lucide="briefcase" class="w-6 h-6 text-gray-500"></i>
          </div>
          <p class="text-gray-600 text-2xl font-bold mb-2">Placeholder value</p>
          <div class="flex items-center">
            <span
              class="inline-block w-3 h-3 rounded-full bg-green-500 mr-2"
            ></span>
            <span class="text-sm text-gray-500">Indicator</span>
          </div>
        </div>
        <div class="bg-white p-4 rounded-lg shadow">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-lg font-semibold">Payment Speed</h3>
            <i data-lucide="clock" class="w-6 h-6 text-gray-500"></i>
          </div>
          <p class="text-gray-600 text-2xl font-bold mb-2">Placeholder value</p>
          <div class="flex items-center">
            <span
              class="inline-block w-3 h-3 rounded-full bg-yellow-500 mr-2"
            ></span>
            <span class="text-sm text-gray-500">Indicator</span>
          </div>
        </div>
        <div class="bg-white p-4 rounded-lg shadow">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-lg font-semibold">People Employed</h3>
            <i data-lucide="users" class="w-6 h-6 text-gray-500"></i>
          </div>
          <p class="text-gray-600 text-2xl font-bold mb-2">Placeholder value</p>
        </div>
        <div class="bg-white p-4 rounded-lg shadow">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-lg font-semibold">State Comparison</h3>
            <i data-lucide="bar-chart" class="w-6 h-6 text-gray-500"></i>
          </div>
          <p class="text-gray-600 text-2xl font-bold mb-2">Placeholder value</p>
          <div class="flex items-center">
            <i data-lucide="arrow-up" class="w-4 h-4 text-green-500 mr-1"></i>
            <span class="text-sm text-gray-500">Better</span>
          </div>
        </div>
      </div>
      <div class="bg-white p-4 rounded-lg shadow mb-4">
        <h3 class="text-lg font-semibold mb-2">6-Month Historical Chart</h3>
        <canvas id="historical-chart"></canvas>
      </div>
      <button
        id="help-button"
        class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700"
      >
        What does this mean?
      </button>
    </main>
    <div
      id="help-modal"
      class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center"
    >
      <div class="bg-white p-6 rounded-lg shadow-lg max-w-md w-full">
        <h2 class="text-xl font-bold mb-4">Help</h2>
        <p class="text-gray-700 mb-4">
          This dashboard provides insights into MGNREGA performance metrics for
          selected districts in Uttar Pradesh.
        </p>
        <button
          id="close-modal"
          class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
        >
          Close
        </button>
      </div>
    </div>
    <script>
      // Mock database simulating Firestore
      const mockDB = {
        lucknow: {
          workAvailability: "High",
          workAvailabilityColor: "green",
          paymentSpeed: "Good",
          paymentSpeedColor: "green",
          peopleEmployed: "1.45 Lakh",
          stateComparison: "Better",
          stateComparisonColor: "green",
          historicalEmployed: [12000, 13000, 12500, 14000, 13500, 14500],
          helpText: {
            workAvailability:
              "This shows if enough work is being created for eligible applicants in the district.",
            paymentSpeed:
              "This indicates how quickly payments are processed and disbursed to workers.",
            peopleEmployed:
              "Number of people employed under MGNREGA in the district.",
            stateComparison:
              "Comparison of district performance against the state average.",
            historicalEmployed: "Employment trend over the last 6 months.",
          },
        },
        varanasi: {
          workAvailability: "Medium",
          workAvailabilityColor: "yellow",
          paymentSpeed: "Okay",
          paymentSpeedColor: "yellow",
          peopleEmployed: "1.20 Lakh",
          stateComparison: "Worse",
          stateComparisonColor: "red",
          historicalEmployed: [11000, 11500, 11800, 11200, 11700, 11900],
          helpText: {
            workAvailability:
              "This shows if enough work is being created for eligible applicants in the district.",
            paymentSpeed:
              "This indicates how quickly payments are processed and disbursed to workers.",
            peopleEmployed:
              "Number of people employed under MGNREGA in the district.",
            stateComparison:
              "Comparison of district performance against the state average.",
            historicalEmployed: "Employment trend over the last 6 months.",
          },
        },
        agra: {
          workAvailability: "Low",
          workAvailabilityColor: "red",
          paymentSpeed: "Bad",
          paymentSpeedColor: "red",
          peopleEmployed: "0.95 Lakh",
          stateComparison: "Worse",
          stateComparisonColor: "red",
          historicalEmployed: [9500, 9800, 9600, 10000, 9700, 9900],
          helpText: {
            workAvailability:
              "This shows if enough work is being created for eligible applicants in the district.",
            paymentSpeed:
              "This indicates how quickly payments are processed and disbursed to workers.",
            peopleEmployed:
              "Number of people employed under MGNREGA in the district.",
            stateComparison:
              "Comparison of district performance against the state average.",
            historicalEmployed: "Employment trend over the last 6 months.",
          },
        },
      };

      // Global variables
      let jwtToken = null;
      let chartInstance = null;

      // DOM element selections
      const districtSelect = document.getElementById("district-select");
      const loadingSpinner = document.getElementById("loading-spinner");
      const errorMessage = document.getElementById("error-message");
      const helpModal = document.getElementById("help-modal");
      const helpButton = document.getElementById("help-button");
      const closeModal = document.getElementById("close-modal");
      const historicalChart = document.getElementById("historical-chart");
      const metricCards = document.querySelectorAll(
        ".grid.grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-4 .bg-white"
      );

      // Function to get JWT token
      async function getToken() {
        try {
          const response = await fetch("/api/auth/token");
          if (!response.ok) throw new Error("Failed to get token");
          const data = await response.json();
          jwtToken = data.token;
          return jwtToken;
        } catch (error) {
          console.error("Error getting token:", error);
          return null;
        }
      }

      // Function to fetch districts from API
      async function fetchDistricts() {
        if (!jwtToken) {
          await getToken();
        }
        try {
          const response = await fetch("/api/districts", {
            headers: {
              Authorization: `Bearer ${jwtToken}`,
            },
          });
          if (!response.ok) throw new Error("Failed to fetch districts");
          const districts = await response.json();
          return districts;
        } catch (error) {
          console.error("Error fetching districts:", error);
          return [];
        }
      }

      // Function to populate district dropdown
      async function populateDistrictDropdown() {
        const districts = await fetchDistricts();
        if (districtSelect) {
          districtSelect.innerHTML =
            '<option value="">Select a district</option>';
          districts.forEach((district) => {
            const option = document.createElement("option");
            option.value = district.id;
            option.textContent = district.name;
            districtSelect.appendChild(option);
          });

          // If no district is selected and districts are loaded, select the first one
          if (districtSelect.value === "" && districts.length > 0) {
            districtSelect.value = districts[0].id;
            fetchDistrictData(districts[0].id);
          }
        }
      }

      // Function to fetch district data from API
      async function fetchDistrictDataFromAPI(districtId) {
        if (!jwtToken) {
          await getToken();
        }
        try {
          const response = await fetch(`/api/data/${districtId}`, {
            headers: {
              Authorization: `Bearer ${jwtToken}`,
            },
          });
          if (!response.ok) throw new Error("Failed to fetch data");
          const data = await response.json();
          return data;
        } catch (error) {
          console.error("Error fetching data from API:", error);
          return null;
        }
      }

      // Function to render data for the selected district
      function renderData(districtData) {
        // Update metric cards
        if (metricCards.length >= 4) {
          // Work Availability
          const workText = metricCards[0].querySelector("p.text-2xl");
          if (workText) workText.textContent = districtData.workAvailability;
          const workIndicator =
            metricCards[0].querySelector("span.rounded-full");
          if (workIndicator)
            workIndicator.className = `inline-block w-3 h-3 rounded-full bg-${districtData.workAvailabilityColor}-500 mr-2`;

          // Payment Speed
          const paymentText = metricCards[1].querySelector("p.text-2xl");
          if (paymentText) paymentText.textContent = districtData.paymentSpeed;
          const paymentIndicator =
            metricCards[1].querySelector("span.rounded-full");
          if (paymentIndicator)
            paymentIndicator.className = `inline-block w-3 h-3 rounded-full bg-${districtData.paymentSpeedColor}-500 mr-2`;

          // People Employed
          const employedText = metricCards[2].querySelector("p.text-2xl");
          if (employedText)
            employedText.textContent = districtData.peopleEmployed;

          // State Comparison
          const comparisonText = metricCards[3].querySelector("p.text-2xl");
          if (comparisonText)
            comparisonText.textContent = districtData.stateComparison;
          const comparisonIcon = metricCards[3].querySelector("i[data-lucide]");
          const comparisonSpan = metricCards[3].querySelector("span.text-sm");
          if (comparisonIcon) {
            if (districtData.stateComparison === "Better") {
              comparisonIcon.setAttribute("data-lucide", "arrow-up");
            } else {
              comparisonIcon.setAttribute("data-lucide", "arrow-down");
            }
            comparisonIcon.className = `w-4 h-4 text-${districtData.stateComparisonColor}-500 mr-1`;
          }
          if (comparisonSpan)
            comparisonSpan.textContent = districtData.stateComparison;
        }

        // Call renderChart function
        renderChart(districtData.historicalEmployed);

        // Populate help modal
        const helpModalP = document.querySelector(
          "#help-modal p.text-gray-700"
        );
        if (helpModalP) {
          const helpContent = Object.entries(districtData.helpText)
            .map(
              ([key, value]) =>
                `<p><strong>${key
                  .replace(/([A-Z])/g, " $1")
                  .toLowerCase()}:</strong> ${value}</p>`
            )
            .join("");
          helpModalP.innerHTML = helpContent;
        }

        // Reinitialize Lucide icons
        lucide.createIcons();
      }

      // Function to render chart
      function renderChart(historicalData) {
        if (chartInstance) {
          chartInstance.destroy();
        }
        if (historicalChart) {
          const ctx = historicalChart.getContext("2d");
          chartInstance = new Chart(ctx, {
            type: "line",
            data: {
              labels: [
                "Month 1",
                "Month 2",
                "Month 3",
                "Month 4",
                "Month 5",
                "Month 6",
              ],
              datasets: [
                {
                  label: "People Employed",
                  data: historicalData,
                  borderColor: "rgb(75, 192, 192)",
                  tension: 0.1,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  position: "top",
                },
                title: {
                  display: true,
                  text: "Employment Trend Over 6 Months",
                },
              },
            },
          });
        }
      }

      // Async function to fetch district data
      async function fetchDistrictData(districtId) {
        // Show loading spinner and hide main dashboard and error message
        if (loadingSpinner) loadingSpinner.classList.remove("hidden");
        const metricGrid = document.querySelector(
          ".grid.grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-4"
        );
        const chartDiv =
          document.querySelector("#historical-chart")?.parentElement;
        if (metricGrid) metricGrid.classList.add("hidden");
        if (chartDiv) chartDiv.classList.add("hidden");
        if (errorMessage) errorMessage.classList.add("hidden");

        let districtData = await fetchDistrictDataFromAPI(districtId);

        if (!districtData) {
          // Fallback to mock data
          districtData = mockDB[districtId];
        }

        if (districtData) {
          renderData(districtData);
          // Show main dashboard
          if (metricGrid) metricGrid.classList.remove("hidden");
          if (chartDiv) chartDiv.classList.remove("hidden");
        } else {
          // Show error message
          if (errorMessage) errorMessage.classList.remove("hidden");
        }

        // Hide loading spinner
        if (loadingSpinner) loadingSpinner.classList.add("hidden");
      }

      // Function to attempt automatic district detection using geolocation
      async function tryGeolocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            async (position) => {
              // Simulate reverse geocoding: always resolve to "Lucknow" with ID "lucknow"
              const district = "Lucknow";
              const districtId = "lucknow"; // Adjusted to match dropdown values and fetchDistrictData expectation
              if (districtSelect) districtSelect.value = districtId;
              fetchDistrictData(districtId);
            },
            (error) => {
              // Do nothing on error or denial
            }
          );
        }
      }

      // Add event listener to district selection dropdown
      if (districtSelect) {
        districtSelect.addEventListener("change", () => {
          const selectedDistrict = districtSelect.value;
          fetchDistrictData(selectedDistrict);
        });
      }

      // Add event listeners for help modal
      if (helpButton) {
        helpButton.addEventListener("click", () => {
          if (helpModal) helpModal.classList.remove("hidden");
        });
      }

      if (closeModal) {
        closeModal.addEventListener("click", () => {
          if (helpModal) helpModal.classList.add("hidden");
        });
      }

      // Initialize Lucide icons
      lucide.createIcons();

      // Get token on page load and populate districts
      getToken().then(() => {
        populateDistrictDropdown();
      });

      // Call tryGeolocation when the script first loads
      tryGeolocation();
    </script>
  </body>
</html>
